<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Simple scrollbar styling for a consistent look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .placeholder-gray-500::placeholder { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Batch Image Generator</h1>
            <p class="text-gray-400">Generate multiple images from a list of prompts using preset services.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ========== Configuration Column ========== -->
            <div class="flex flex-col space-y-6">
                <!-- Prompts Section -->
                <div>
                    <label for="prompts" class="block text-sm font-medium text-gray-300 mb-2">1. Enter Prompts (one per line)</label>
                    <textarea id="prompts" rows="8" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-200 placeholder-gray-500" placeholder="A futuristic city at sunset&#10;A robot reading a book in a library&#10;A fantasy landscape with floating islands...">A smiling sloth in a business suit
A majestic jellyfish floating in a starry galaxy
A cozy library in a treehouse during a gentle rain</textarea>
                </div>

                <!-- API Configuration Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3">2. Service Configuration</h2>
                    <div class="space-y-4 bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="promptPrefix" class="block text-sm font-medium text-gray-300">Prompt Prefix</label>
                                <input type="text" id="promptPrefix" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="e.g., photo of">
                            </div>
                            <div>
                                <label for="promptSuffix" class="block text-sm font-medium text-gray-300">Prompt Suffix</label>
                                <input type="text" id="promptSuffix" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="e.g., 4k, detailed">
                            </div>
                        </div>
                        <div>
                            <label for="servicePreset" class="block text-sm font-medium text-gray-300">Image Generation Service</label>
                            <select id="servicePreset" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="poe-seedream4" selected>Poe - Seedream-4.0 (API Key)</option>
                                <option value="poe-imagen4">Poe - Imagen 4 (API Key)</option>
                                <option value="google-imagen3-apikey">Google - Imagen 3 (API Key)</option>
                                <option value="openai-dalle3">OpenAI - DALL-E 3</option>
                            </select>
                        </div>

                        <!-- Advanced Settings -->
                        <div id="advancedImageSettings" class="space-y-4 p-3 bg-gray-900/50 rounded-md border border-gray-600" style="display: none;">
                            <h4 class="text-sm font-semibold text-gray-300">Advanced Settings</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="aspectRatio" class="block text-xs font-medium text-gray-400">Aspect Ratio</label>
                                    <select id="aspectRatio" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-sm">
                                        <option value="default">Default</option>
                                        <option value="1:1">1:1 (Square)</option>
                                        <option value="16:9">16:9 (Widescreen)</option>
                                        <option value="9:16">9:16 (Vertical)</option>
                                        <option value="4:3">4:3 (Standard)</option>
                                        <option value="3:4">3:4 (Portrait)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="numberOfImages" class="block text-xs font-medium text-gray-400">Number of Images</label>
                                    <input type="number" id="numberOfImages" value="1" min="1" max="8" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-sm">
                                </div>
                            </div>
                            <div id="poeReferenceImageSection" style="display: none;">
                                <label for="referenceImage" class="block text-xs font-medium text-gray-400">Reference Image (Optional)</label>
                                <div id="referenceImageDropZone" class="mt-1 w-full p-4 bg-gray-700 border-2 border-dashed border-gray-600 rounded-md text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-600 transition-colors">
                                    <div id="referenceImagePreview" class="hidden mb-2">
                                        <img id="referenceImagePreviewImg" class="mx-auto max-h-32 rounded-md" alt="Reference preview">
                                        <button id="removeReferenceImage" class="mt-2 px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">Remove</button>
                                    </div>
                                    <div id="referenceImagePlaceholder">
                                        <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-2 text-xs text-gray-400">Click to upload, drag & drop, or paste (Ctrl/Cmd+V)</p>
                                        <p class="mt-1 text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                    </div>
                                </div>
                                <input type="file" id="referenceImage" accept="image/*" class="hidden">
                            </div>
                        </div>

                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-300">API Key</label>
                            <input type="password" id="apiKey" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="Enter your API key">
                            <p id="apiKeyHelpText" class="mt-2 text-xs text-gray-400" style="display: none;">
                                To use this, you need a Google Cloud API Key. 
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-indigo-400 hover:underline">Create one here</a>.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div>
                     <h2 class="text-lg font-semibold text-white mb-3">3. Generate & Download</h2>
                    <div class="flex items-center space-x-4">
                        <button id="startButton" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 transition duration-150">Start Generation</button>
                        <button id="stopButton" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-150" disabled>Stop</button>
                    </div>
                </div>
                
                <!-- Progress -->
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div id="status" class="text-gray-400 text-sm">Status: Idle</div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ========== Output Column ========== -->
            <div class="flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Results</h2>
                    <button id="downloadButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-150" disabled>Download All as .zip</button>
                </div>
                <div id="resultsGrid" class="flex-grow bg-gray-800/50 border border-gray-700 rounded-lg p-4 h-96 lg:h-auto overflow-y-auto">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-4">
                        <!-- Generated images will appear here -->
                    </div>
                     <div id="placeholder" class="flex items-center justify-center h-full">
                        <p class="text-gray-500">Your generated images will appear here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Presets ---
        const SERVICE_PRESETS = {
            'poe-seedream4': {
                name: 'Poe - Seedream-4.0 (API Key)',
                authType: 'bearer',
                apiUrl: 'https://api.poe.com/v1/chat/completions',
                getBody: (prompt, params) => {
                    let finalPrompt = prompt;
                    // Only add the aspect ratio if it's not 'default' and not already in the prompt.
                    if (params.aspectRatio !== 'default' && !prompt.includes('--aspect_ratio') && !prompt.includes('--aspect')) {
                        finalPrompt = `${prompt} --aspect ${params.aspectRatio}`;
                    }

                    const messageContent = [];
                    if (params.referenceImageBase64) {
                        messageContent.push({
                            type: "image_url",
                            image_url: {
                                url: `data:image/jpeg;base64,${params.referenceImageBase64}`
                            }
                        });
                    }
                    messageContent.push({
                        type: "text",
                        text: finalPrompt
                    });

                    return JSON.stringify({
                        model: "Seedream-4.0",
                        messages: [{
                            role: "user",
                            content: messageContent
                        }]
                    });
                },
                responsePath: 'choices'
            },
            'poe-imagen4': {
                name: 'Poe - Imagen 4 (API Key)',
                authType: 'bearer',
                apiUrl: 'https://api.poe.com/v1/chat/completions',
                getBody: (prompt, params) => {
                    let finalPrompt = prompt;
                    // Only add the aspect ratio if it's not 'default' and not already in the prompt.
                    if (params.aspectRatio !== 'default' && !prompt.includes('--aspect_ratio') && !prompt.includes('--aspect')) {
                        finalPrompt = `${prompt} --aspect ${params.aspectRatio}`;
                    }

                    const messageContent = [];
                    if (params.referenceImageBase64) {
                        messageContent.push({
                            type: "image_url",
                            image_url: {
                                url: `data:image/jpeg;base64,${params.referenceImageBase64}`
                            }
                        });
                    }
                    messageContent.push({
                        type: "text",
                        text: finalPrompt
                    });

                    return JSON.stringify({
                        model: "Imagen-4",
                        messages: [{
                            role: "user",
                            content: messageContent
                        }]
                    });
                },
                responsePath: 'choices'
            },
            'google-imagen3-apikey': {
                name: 'Google - Imagen 3 (API Key)',
                authType: 'apiKeyInUrl',
                apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict',
                getBody: (prompt, params) => {
                    const parameters = {
                        sampleCount: params.numberOfImages
                    };
                    // Only add aspect ratio to the request if it's not the default.
                    if (params.aspectRatio !== 'default') {
                        parameters.aspectRatio = params.aspectRatio;
                    }
                    return JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: parameters
                    });
                },
                responsePath: 'predictions'
            },
            'openai-dalle3': {
                name: 'OpenAI - DALL-E 3',
                authType: 'bearer',
                apiUrl: 'https://api.openai.com/v1/images/generations',
                getBody: (prompt) => {
                     return JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: "1024x1024",
                        response_format: "b64_json"
                    });
                },
                responsePath: 'data'
            }
        };

        // DOM Elements
        const promptsEl = document.getElementById('prompts');
        const servicePresetEl = document.getElementById('servicePreset');
        const apiKeyEl = document.getElementById('apiKey');
        const apiKeyHelpTextEl = document.getElementById('apiKeyHelpText');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusEl = document.getElementById('status');
        const progressBarEl = document.getElementById('progressBar');
        const resultsGrid = document.getElementById('resultsGrid').querySelector('.grid');
        const placeholderEl = document.getElementById('placeholder');
        const promptPrefixEl = document.getElementById('promptPrefix');
        const promptSuffixEl = document.getElementById('promptSuffix');
        const advancedImageSettingsEl = document.getElementById('advancedImageSettings');
        const aspectRatioEl = document.getElementById('aspectRatio');
        const numberOfImagesEl = document.getElementById('numberOfImages');
        const referenceImageEl = document.getElementById('referenceImage');
        const poeReferenceImageSectionEl = document.getElementById('poeReferenceImageSection');
        const referenceImageDropZoneEl = document.getElementById('referenceImageDropZone');
        const referenceImagePreviewEl = document.getElementById('referenceImagePreview');
        const referenceImagePreviewImgEl = document.getElementById('referenceImagePreviewImg');
        const referenceImagePlaceholderEl = document.getElementById('referenceImagePlaceholder');
        const removeReferenceImageEl = document.getElementById('removeReferenceImage');

        // State for reference image
        let referenceImageFile = null;

        // State
        let isGenerating = false;
        let generatedImages = [];
        let generationTimestamp = '';
        
        // --- Helper to add a delay ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- Helper Functions ---
        const fileToBase64 = (file, convertAlphaToWhite = false) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (convertAlphaToWhite) {
                        // Load image into canvas to convert alpha to white
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');

                            // Fill with white background
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // Draw image on top
                            ctx.drawImage(img, 0, 0);

                            // Convert to base64
                            const base64String = canvas.toDataURL('image/jpeg', 0.95).split(',')[1];
                            resolve(base64String);
                        };
                        img.onerror = reject;
                        img.src = reader.result;
                    } else {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const handleReferenceImageFile = (file) => {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('Image size must be less than 10MB');
                return;
            }

            referenceImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                referenceImagePreviewImgEl.src = e.target.result;
                referenceImagePlaceholderEl.classList.add('hidden');
                referenceImagePreviewEl.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        };

        const clearReferenceImage = () => {
            referenceImageFile = null;
            referenceImageEl.value = '';
            referenceImagePreviewImgEl.src = '';
            referenceImagePlaceholderEl.classList.remove('hidden');
            referenceImagePreviewEl.classList.add('hidden');
        };

        const sanitizeForFilename = (name, maxLength = 50) => {
            if (!name) return '';
            return name
                .trim()
                .toLowerCase()
                .substring(0, maxLength)
                .replace(/\s+/g, '_')
                .replace(/[^\w.-]/g, '');
        };

        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(36).substring(0, 6);
        };

        const getNestedValue = (obj, path) => {
            try {
                const properties = path.replace(/\[(\w+)\]/g, '.$1').split('.');
                return properties.reduce((acc, key) => acc && acc[key], obj);
            } catch (error) {
                console.error("Error accessing nested value:", error);
                return undefined;
            }
        };

        const urlToBase64 = (url) => {
            // This function fetches an image from a URL and converts it to a base64 string.
            // It uses a CORS proxy to bypass browser security restrictions.
            return new Promise(async (resolve, reject) => {
                try {
                    const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch image via proxy: ${response.status} ${response.statusText}`);
                    }
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        resolve(reader.result.split(',')[1]);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                } catch (error) {
                    reject(error);
                }
            });
        };
        
        const extractImageData = (item, presetKey) => {
            // This function knows how to find the image data (either base64 or a URL)
            // in the response from different APIs.
            if (presetKey.startsWith('google-')) return { base64: item.bytesBase64Encoded };
            if (presetKey === 'openai-dalle3') return { base64: item.b64_json };
            if (presetKey === 'poe-imagen4' || presetKey === 'poe-seedream4') {
                const content = item.message?.content;
                if (content) {
                    // Poe returns the URL in a markdown-like format, so we extract it.
                    const urlMatch = content.match(/(https?:\/\/[^\s)]+)/);
                    if (urlMatch && urlMatch[0]) {
                        return { url: urlMatch[0] };
                    }
                }
            }
            return {};
        };

        const updateProgress = (text, percentage) => {
            statusEl.textContent = `Status: ${text}`;
            progressBarEl.style.width = `${percentage}%`;
        };
        
        const renderImageCard = ({ filename, base64Data, error, aspectRatio = '1:1' }) => {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'w-full bg-gray-700 flex items-center justify-center';
            // Dynamically set the aspect ratio for the container
            imageContainer.style.aspectRatio = aspectRatio.replace(':', ' / ');

            if (error) {
                imageContainer.innerHTML = `<p class="text-center text-red-400 text-xs p-2">${error}</p>`;
            } else {
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${base64Data}`;
                img.alt = filename;
                img.className = 'w-full h-full object-cover';
                imageContainer.appendChild(img);
            }
            
            const nameEl = document.createElement('p');
            nameEl.textContent = filename;
            nameEl.className = 'p-2 text-xs text-center text-gray-400 bg-gray-900 truncate';

            card.appendChild(imageContainer);
            card.appendChild(nameEl);
            resultsGrid.appendChild(card);
        };

        const updateAuthUI = () => {
            const selectedValue = servicePresetEl.value;

            apiKeyHelpTextEl.style.display = 'none';
            advancedImageSettingsEl.style.display = 'none';
            poeReferenceImageSectionEl.style.display = 'none';

            if (selectedValue === 'google-imagen3-apikey' || selectedValue === 'poe-imagen4' || selectedValue === 'poe-seedream4') {
                apiKeyEl.placeholder = "Enter your API Key";
                if (selectedValue === 'google-imagen3-apikey') {
                    apiKeyHelpTextEl.style.display = 'block';
                }
                advancedImageSettingsEl.style.display = 'block';
                if (selectedValue === 'poe-imagen4' || selectedValue === 'poe-seedream4') {
                    poeReferenceImageSectionEl.style.display = 'block';
                }
            } else {
                apiKeyEl.placeholder = "Enter your API key";
            }
        };

        // --- Core Logic ---
        const startGeneration = async () => {
            const prompts = promptsEl.value.split('\n').filter(p => p.trim() !== '');
            const apiKey = apiKeyEl.value.trim();
            const selectedPresetKey = servicePresetEl.value;
            const selectedPreset = SERVICE_PRESETS[selectedPresetKey];

            const prefix = promptPrefixEl.value.trim();
            const suffix = promptSuffixEl.value.trim();
            const advancedParams = {
                aspectRatio: aspectRatioEl.value,
                numberOfImages: parseInt(numberOfImagesEl.value, 10) || 1
            };

            // Handle reference image for POE models
            if ((selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') && referenceImageFile) {
                try {
                    // Convert alpha channel to white background for POE models
                    advancedParams.referenceImageBase64 = await fileToBase64(referenceImageFile, true);
                } catch (error) {
                    alert('Failed to load reference image: ' + error.message);
                    return;
                }
            }

            if (prompts.length === 0 || !apiKey) {
                alert('Please enter your prompts and provide an API key.');
                return;
            }
            
            isGenerating = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            downloadButton.disabled = true;
            resultsGrid.innerHTML = '';
            placeholderEl.style.display = 'none';
            generatedImages = [];
            const now = new Date();
            generationTimestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

            let totalGenerations = 0;
            prompts.forEach(p => {
                totalGenerations += (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4' || selectedPresetKey === 'google-imagen3-apikey') ? advancedParams.numberOfImages : 1;
            });
            let completedGenerations = 0;

            for (let i = 0; i < prompts.length; i++) {
                if (!isGenerating) {
                    updateProgress(`Stopped by user.`, (completedGenerations / totalGenerations) * 100);
                    break;
                }
                
                const currentPrompt = prompts[i];
                const fullPrompt = [prefix, currentPrompt, suffix].filter(Boolean).join(' ');

                const sanitizedPrompt = sanitizeForFilename(currentPrompt, 25);
                const sanitizedPrefix = sanitizeForFilename(prefix, 10);
                const sanitizedSuffix = sanitizeForFilename(suffix, 10);
                const baseFilename = [String(i + 1).padStart(3, '0'), sanitizedPrompt, sanitizedPrefix, sanitizedSuffix].filter(Boolean).join('_');
                
                let numRequests = 1;
                let isMultiRequest = false;

                if ((selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4' || selectedPresetKey === 'google-imagen3-apikey')) {
                    numRequests = advancedParams.numberOfImages;
                    isMultiRequest = true;
                }

                for (let j = 0; j < numRequests; j++) {
                    if (!isGenerating) break;

                    completedGenerations++;
                    const progressPercentage = (completedGenerations / totalGenerations) * 100;
                    updateProgress(`Generating image ${j + 1} for prompt ${i + 1}...`, progressPercentage);
                    
                    let attempt = 0;
                    const maxAttempts = 2;
                    let success = false;

                    while (attempt < maxAttempts && !success && isGenerating) {
                        attempt++;
                        try {
                            let body;
                            // For Google, we pass the full image count. For Poe, we always pass 1 and loop.
                            if(selectedPresetKey === 'google-imagen3-apikey' && !isMultiRequest) {
                                 body = selectedPreset.getBody(fullPrompt, advancedParams);
                            } else {
                                 body = selectedPreset.getBody(fullPrompt, { ...advancedParams, numberOfImages: 1 });
                            }
                            
                            let finalUrl = selectedPreset.apiUrl;
                            const fetchOptions = {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                                body: body
                            };

                            if (selectedPreset.authType === 'bearer') {
                                fetchOptions.headers['Authorization'] = `Bearer ${apiKey}`;
                            } else if (selectedPreset.authType === 'apiKeyInUrl') {
                                finalUrl = `${selectedPreset.apiUrl}?key=${apiKey}`;
                            }
                            
                            const response = await fetch(finalUrl, fetchOptions);
                           
                            if (response.status === 500 && (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') && attempt < maxAttempts) {
                                throw new Error('Server error (500)'); // Trigger the retry logic
                            }

                            const data = await response.json();

                            if (!response.ok) {
                                const errorMessage = data?.error?.message || `API Error: ${response.status}`;
                                throw new Error(errorMessage);
                            }

                            success = true; // Mark as successful to exit the retry loop
                            const resultsArray = getNestedValue(data, selectedPreset.responsePath);

                            if (!resultsArray || !Array.isArray(resultsArray) || resultsArray.length === 0) {
                               if (data.error && data.error.message) throw new Error(data.error.message);
                               throw new Error('No image data found in API response.');
                            }
                            
                            let currentAspectRatio = '1:1';
                            if ((selectedPresetKey === 'google-imagen3-apikey' || selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') && advancedParams.aspectRatio !== 'default') {
                                currentAspectRatio = advancedParams.aspectRatio;
                            }

                            for (const [index, item] of resultsArray.entries()) {
                                 if (!isGenerating) break;

                                let { base64, url } = extractImageData(item, selectedPresetKey);

                                if (url) {
                                    base64 = await urlToBase64(url);
                                }
                                
                                if (base64) {
                                     const contentHash = simpleHash(base64);
                                     let filename;
                                     if (isMultiRequest) {
                                         filename = `${baseFilename}_${j + 1}_${contentHash}.png`;
                                     } else if (resultsArray.length > 1) {
                                         filename = `${baseFilename}_${index + 1}_${contentHash}.png`;
                                     } else {
                                         filename = `${baseFilename}_${contentHash}.png`;
                                     }
                                    const imageData = { filename, base64Data: base64 };
                                    generatedImages.push(imageData);
                                    renderImageCard({ ...imageData, aspectRatio: currentAspectRatio });
                                }
                            }
                           
                            if (isMultiRequest && j < numRequests - 1 && (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4')) {
                                updateProgress(`Waiting before next request...`, progressPercentage);
                                await sleep(1500);
                            }

                        } catch (error) {
                            console.error(`Attempt ${attempt} failed:`, error);
                            if (error.message.includes('Server error (500)') && attempt < maxAttempts) {
                                updateProgress(`Server error. Retrying request ${j + 1} (attempt ${attempt + 1}/${maxAttempts})...`, progressPercentage);
                                await sleep(2000); // Wait before retrying
                            } else {
                                renderImageCard({ filename: `${baseFilename}.png`, error: error.message, aspectRatio: '1:1' });
                                break; // Break from the retry loop on non-retryable errors
                            }
                        }
                    }
                }
            }

            if (isGenerating) {
                 updateProgress(`Generation complete! ${generatedImages.length} images created.`, 100);
            }
            isGenerating = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            if (generatedImages.length > 0) {
                downloadButton.disabled = false;
            }
        };

        const downloadZip = async () => {
            if (generatedImages.length === 0) return;

            const zip = new JSZip();

            generatedImages.forEach(img => {
                zip.file(img.filename, img.base64Data, { base64: true });
            });

            // Add reference image if it exists
            if (referenceImageFile) {
                try {
                    const referenceBase64 = await fileToBase64(referenceImageFile);
                    const extension = referenceImageFile.name.split('.').pop() || 'png';
                    zip.file(`reference_image.${extension}`, referenceBase64, { base64: true });
                } catch (error) {
                    console.error('Failed to add reference image to zip:', error);
                }
            }

            const selectedPresetKey = servicePresetEl.value;
            const selectedOption = servicePresetEl.options[servicePresetEl.selectedIndex].text;

            let settingsContent = `Generation Settings (${new Date().toLocaleString()})\n`;
            settingsContent += `==================================================\n\n`;
            settingsContent += `Service: ${selectedOption}\n`;
            settingsContent += `Timestamp: ${generationTimestamp}\n`;
            settingsContent += `Prompt Prefix: ${promptPrefixEl.value}\n`;
            settingsContent += `Prompt Suffix: ${promptSuffixEl.value}\n\n`;

            if (selectedPresetKey === 'google-imagen3-apikey' || selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') {
                settingsContent += `--- Advanced Settings ---\n`;
                settingsContent += `Aspect Ratio: ${aspectRatioEl.value}\n`;
                settingsContent += `Number of Images Per Prompt: ${numberOfImagesEl.value}\n`;
                if (referenceImageFile) {
                    settingsContent += `Reference Image: reference_image.${referenceImageFile.name.split('.').pop() || 'png'}\n`;
                }
                settingsContent += `\n`;
            }

            settingsContent += `--- Full Prompts List ---\n`;
            settingsContent += promptsEl.value;

            zip.file('generation_settings.txt', settingsContent);

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `generated_images_${generationTimestamp}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        };

        // --- Event Listeners ---
        startButton.addEventListener('click', startGeneration);
        stopButton.addEventListener('click', () => { isGenerating = false; });
        downloadButton.addEventListener('click', downloadZip);
        servicePresetEl.addEventListener('change', updateAuthUI);

        // Reference image handlers
        referenceImageDropZoneEl.addEventListener('click', () => referenceImageEl.click());
        referenceImageEl.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleReferenceImageFile(e.target.files[0]);
            }
        });
        removeReferenceImageEl.addEventListener('click', (e) => {
            e.stopPropagation();
            clearReferenceImage();
        });

        // Drag and drop handlers
        referenceImageDropZoneEl.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            referenceImageDropZoneEl.classList.add('border-indigo-500', 'bg-gray-600');
        });
        referenceImageDropZoneEl.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            referenceImageDropZoneEl.classList.remove('border-indigo-500', 'bg-gray-600');
        });
        referenceImageDropZoneEl.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            referenceImageDropZoneEl.classList.remove('border-indigo-500', 'bg-gray-600');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleReferenceImageFile(files[0]);
            }
        });

        // Paste handler for reference image (global listener)
        document.addEventListener('paste', (e) => {
            // Only handle paste when POE reference section is visible
            if (poeReferenceImageSectionEl.style.display !== 'none') {
                const items = e.clipboardData?.items;
                if (items) {
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = items[i].getAsFile();
                            if (file) {
                                handleReferenceImageFile(file);
                            }
                            break;
                        }
                    }
                }
            }
        });

        // --- Initial UI Setup ---
        document.addEventListener('DOMContentLoaded', updateAuthUI);
    </script>
</body>
</html>

