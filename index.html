<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Generator</title>
    <link rel="icon" type="image/png" href="images/logo_draw.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Simple scrollbar styling for a consistent look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .placeholder-gray-500::placeholder { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div class="container mx-auto p-4 lg:p-8 max-w-7xl">
        <header class="text-center mb-6">
            <img src="images/logo_draw.png" alt="Logo" class="mx-auto mb-3 h-12 w-auto">
            <h1 class="text-3xl font-bold text-white mb-1">Batch Image Generator</h1>
            <p class="text-gray-400 text-sm">Generate multiple images from prompts using AI services</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- ========== Configuration Column ========== -->
            <div class="lg:col-span-2 flex flex-col space-y-4">
                <!-- Prompts Section -->
                <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-semibold text-white mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Prompts
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label for="prompts" class="block text-xs font-medium text-gray-300 mb-1">Positive Prompts (one per line)</label>
                            <textarea id="prompts" rows="5" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-200 placeholder-gray-500 text-sm" placeholder="A futuristic city at sunset&#10;A robot reading a book&#10;A fantasy landscape with floating islands">A smiling sloth in a business suit
A majestic jellyfish floating in a starry galaxy
A cozy library in a treehouse during a gentle rain</textarea>
                        </div>
                        <div>
                            <label for="negativePrompt" class="block text-xs font-medium text-gray-300 mb-1">Negative Prompt (optional)</label>
                            <input type="text" id="negativePrompt" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-200 placeholder-gray-500" placeholder="e.g., ugly, deformed, blurry, low quality">
                        </div>
                        <div id="promptPreview" class="p-2 bg-gray-900/70 rounded border border-gray-600 text-xs text-gray-400 hidden">
                            <span class="font-medium text-gray-300">Preview:</span> <span id="promptPreviewText"></span>
                        </div>
                    </div>
                </div>

                <!-- Generation Settings Section -->
                <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-semibold text-white mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                        </svg>
                        Generation Settings
                    </h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="servicePreset" class="block text-xs font-medium text-gray-300 mb-1">Service</label>
                                <select id="servicePreset" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                    <option value="poe-seedream4" selected>Poe - Seedream-4.0</option>
                                    <option value="poe-imagen4">Poe - Imagen 4</option>
                                    <option value="google-imagen3-apikey">Google - Imagen 3</option>
                                    <option value="openai-dalle3">OpenAI - DALL-E 3</option>
                                </select>
                            </div>
                            <div id="aspectRatioContainer">
                                <label for="aspectRatio" class="block text-xs font-medium text-gray-300 mb-1">Aspect Ratio</label>
                                <select id="aspectRatio" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="default">Default</option>
                                    <option value="1:1">1:1 Square</option>
                                    <option value="16:9">16:9 Wide</option>
                                    <option value="9:16">9:16 Vertical</option>
                                    <option value="4:3">4:3 Standard</option>
                                    <option value="3:4">3:4 Portrait</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="apiKey" class="block text-xs font-medium text-gray-300 mb-1">API Key</label>
                                <div class="flex gap-2">
                                    <input type="password" id="apiKey" class="flex-1 p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm" placeholder="Enter your API key">
                                    <button id="clearApiKey" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded text-xs" title="Clear saved key">✕</button>
                                </div>
                                <div class="mt-1 flex items-center justify-between">
                                    <label class="flex items-center text-xs text-gray-400 cursor-pointer">
                                        <input type="checkbox" id="saveApiKey" class="mr-1 rounded">
                                        <span>Remember key</span>
                                    </label>
                                    <p id="apiKeyHelpText" class="text-xs text-gray-400" style="display: none;">
                                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-indigo-400 hover:underline">Get API key →</a>
                                    </p>
                                </div>
                            </div>
                            <div id="numberOfImagesContainer">
                                <label for="numberOfImages" class="block text-xs font-medium text-gray-300 mb-1">Images per Prompt</label>
                                <input type="number" id="numberOfImages" value="1" min="1" max="8" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="promptPrefix" class="block text-xs font-medium text-gray-300 mb-1">Prefix (optional)</label>
                                <input type="text" id="promptPrefix" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500" placeholder="e.g., photo of">
                            </div>
                            <div>
                                <label for="promptSuffix" class="block text-xs font-medium text-gray-300 mb-1">Suffix (optional)</label>
                                <input type="text" id="promptSuffix" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-md shadow-sm text-sm focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 4k, detailed">
                            </div>
                        </div>

                        <!-- Reference Image Section -->
                        <div id="poeReferenceImageSection" style="display: none;">
                            <label for="referenceImage" class="block text-xs font-medium text-gray-300 mb-1">Reference Image (optional)</label>
                            <div id="referenceImageDropZone" class="w-full p-3 bg-gray-800 border-2 border-dashed border-gray-600 rounded-md text-center cursor-pointer hover:border-indigo-500 hover:bg-gray-700 transition-colors">
                                <div id="referenceImagePreview" class="hidden mb-2">
                                    <div id="referenceImagePreviewContainer" class="flex flex-wrap gap-2 justify-center mb-2"></div>
                                    <button id="removeReferenceImage" class="mt-1 px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">Remove All</button>
                                </div>
                                <div id="referenceImagePlaceholder">
                                    <svg class="mx-auto h-8 w-8 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <p class="mt-1 text-xs text-gray-400">Click, drag, or paste image</p>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF (max 10MB)</p>
                                </div>
                            </div>
                            <input type="file" id="referenceImage" accept="image/*" multiple class="hidden">
                        </div>

                        <!-- Proxy Settings -->
                        <details class="group">
                            <summary class="cursor-pointer text-xs text-gray-400 hover:text-gray-300 select-none">⚙️ Proxy Settings</summary>
                            <div class="mt-2 pt-2 border-t border-gray-600">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" id="proxyUrl" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm text-xs focus:ring-2 focus:ring-indigo-500" placeholder="Proxy URL">
                                    <input type="password" id="proxyToken" class="w-full p-2 bg-gray-800 border border-gray-600 rounded-md shadow-sm text-xs focus:ring-2 focus:ring-indigo-500" placeholder="Token (optional)">
                                </div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Action Panel -->
                <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-semibold text-white mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Action Panel
                    </h2>
                    <div id="imageEstimate" class="mb-3 p-2 bg-gray-900/50 rounded border border-gray-600 text-xs text-gray-300">
                        <span class="font-medium">Will generate:</span> <span id="imageCount" class="text-indigo-400 font-semibold">0 images</span>
                    </div>
                    <div class="flex gap-3 mb-3">
                        <button id="startButton" class="flex-1 px-4 py-2.5 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition text-sm">
                            ▶ Start Generation
                        </button>
                        <button id="stopButton" class="px-4 py-2.5 bg-red-600/80 text-white font-semibold rounded-md shadow-md hover:bg-red-700 disabled:bg-gray-700 disabled:cursor-not-allowed disabled:text-gray-500 transition text-sm" disabled>
                            ■ Stop
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div id="status" class="text-gray-400 text-xs">Idle</div>
                        <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div id="progressBar" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== Results Column ========== -->
            <div class="lg:col-span-1 flex flex-col">
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg flex flex-col h-full">
                    <div class="flex justify-between items-center p-3 border-b border-gray-700">
                        <h2 class="text-sm font-semibold text-white">Results</h2>
                        <button id="downloadButton" class="px-3 py-1.5 bg-green-600 text-white font-medium rounded-md shadow-sm hover:bg-green-700 disabled:bg-gray-700 disabled:cursor-not-allowed disabled:text-gray-500 transition text-xs" disabled>
                            ⬇ Download ZIP
                        </button>
                    </div>
                    <div id="resultsGrid" class="flex-grow p-3 overflow-y-auto min-h-[400px] lg:min-h-0">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <!-- Generated images will appear here -->
                        </div>
                        <div id="placeholder" class="flex items-center justify-center h-full">
                            <p class="text-gray-500 text-sm text-center">Generated images<br/>will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Presets ---
        const SERVICE_PRESETS = {
            'poe-seedream4': {
                name: 'Poe - Seedream-4.0 (API Key)',
                authType: 'bearer',
                apiUrl: 'https://api.poe.com/v1/chat/completions',
                getBody: (prompt, params) => {
                    let finalPrompt = prompt;
                    // Only add the aspect ratio if it's not 'default' and not already in the prompt.
                    if (params.aspectRatio !== 'default' && !prompt.includes('--aspect_ratio') && !prompt.includes('--aspect')) {
                        finalPrompt = `${prompt} --aspect ${params.aspectRatio}`;
                    }

                    const messageContent = [];
                    if (params.referenceImageBase64Array && params.referenceImageBase64Array.length > 0) {
                        params.referenceImageBase64Array.forEach(base64 => {
                            messageContent.push({
                                type: "image_url",
                                image_url: {
                                    url: `data:image/jpeg;base64,${base64}`
                                }
                            });
                        });
                    }
                    messageContent.push({
                        type: "text",
                        text: finalPrompt
                    });

                    return JSON.stringify({
                        model: "Seedream-4.0",
                        messages: [{
                            role: "user",
                            content: messageContent
                        }],
                        stream: false  // Recommended for media bots
                    });
                },
                responsePath: 'choices'
            },
            'poe-imagen4': {
                name: 'Poe - Imagen 4 (API Key)',
                authType: 'bearer',
                apiUrl: 'https://api.poe.com/v1/chat/completions',
                getBody: (prompt, params) => {
                    let finalPrompt = prompt;
                    // Only add the aspect ratio if it's not 'default' and not already in the prompt.
                    if (params.aspectRatio !== 'default' && !prompt.includes('--aspect_ratio') && !prompt.includes('--aspect')) {
                        finalPrompt = `${prompt} --aspect ${params.aspectRatio}`;
                    }

                    const messageContent = [];
                    if (params.referenceImageBase64Array && params.referenceImageBase64Array.length > 0) {
                        params.referenceImageBase64Array.forEach(base64 => {
                            messageContent.push({
                                type: "image_url",
                                image_url: {
                                    url: `data:image/jpeg;base64,${base64}`
                                }
                            });
                        });
                    }
                    messageContent.push({
                        type: "text",
                        text: finalPrompt
                    });

                    return JSON.stringify({
                        model: "Imagen-4",
                        messages: [{
                            role: "user",
                            content: messageContent
                        }],
                        stream: false  // Recommended for media bots
                    });
                },
                responsePath: 'choices'
            },
            'google-imagen3-apikey': {
                name: 'Google - Imagen 3 (API Key)',
                authType: 'apiKeyInUrl',
                apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict',
                getBody: (prompt, params) => {
                    const parameters = {
                        sampleCount: params.numberOfImages
                    };
                    // Only add aspect ratio to the request if it's not the default.
                    if (params.aspectRatio !== 'default') {
                        parameters.aspectRatio = params.aspectRatio;
                    }
                    return JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: parameters
                    });
                },
                responsePath: 'predictions'
            },
            'openai-dalle3': {
                name: 'OpenAI - DALL-E 3',
                authType: 'bearer',
                apiUrl: 'https://api.openai.com/v1/images/generations',
                getBody: (prompt) => {
                     return JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: "1024x1024",
                        response_format: "b64_json"
                    });
                },
                responsePath: 'data'
            }
        };

        // DOM Elements
        const promptsEl = document.getElementById('prompts');
        const negativePromptEl = document.getElementById('negativePrompt');
        const promptPreviewEl = document.getElementById('promptPreview');
        const promptPreviewTextEl = document.getElementById('promptPreviewText');
        const servicePresetEl = document.getElementById('servicePreset');
        const apiKeyEl = document.getElementById('apiKey');
        const saveApiKeyEl = document.getElementById('saveApiKey');
        const clearApiKeyEl = document.getElementById('clearApiKey');
        const apiKeyHelpTextEl = document.getElementById('apiKeyHelpText');
        const proxyUrlEl = document.getElementById('proxyUrl');
        const proxyTokenEl = document.getElementById('proxyToken');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusEl = document.getElementById('status');
        const progressBarEl = document.getElementById('progressBar');
        const imageCountEl = document.getElementById('imageCount');
        const resultsGrid = document.getElementById('resultsGrid').querySelector('.grid');
        const placeholderEl = document.getElementById('placeholder');
        const promptPrefixEl = document.getElementById('promptPrefix');
        const promptSuffixEl = document.getElementById('promptSuffix');
        const advancedImageSettingsEl = document.getElementById('advancedImageSettings');
        const aspectRatioEl = document.getElementById('aspectRatio');
        const aspectRatioContainerEl = document.getElementById('aspectRatioContainer');
        const numberOfImagesEl = document.getElementById('numberOfImages');
        const numberOfImagesContainerEl = document.getElementById('numberOfImagesContainer');
        const referenceImageEl = document.getElementById('referenceImage');
        const poeReferenceImageSectionEl = document.getElementById('poeReferenceImageSection');
        const referenceImageDropZoneEl = document.getElementById('referenceImageDropZone');
        const referenceImagePreviewEl = document.getElementById('referenceImagePreview');
        const referenceImagePreviewContainerEl = document.getElementById('referenceImagePreviewContainer');
        const referenceImagePlaceholderEl = document.getElementById('referenceImagePlaceholder');
        const removeReferenceImageEl = document.getElementById('removeReferenceImage');

        // State for reference images (now supports multiple)
        let referenceImageFiles = [];

        // State
        let isGenerating = false;
        let generatedImages = [];
        let generationTimestamp = '';
        
        // --- Helper to add a delay ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- New Helper Functions ---
        // API Key Management
        const loadApiKey = () => {
            const saved = localStorage.getItem('apiKey');
            if (saved) {
                apiKeyEl.value = saved;
                saveApiKeyEl.checked = true;
            }
        };

        const saveApiKey = () => {
            if (saveApiKeyEl.checked) {
                localStorage.setItem('apiKey', apiKeyEl.value);
            } else {
                localStorage.removeItem('apiKey');
            }
        };

        // Prompt Preview
        const updatePromptPreview = () => {
            const prompts = promptsEl.value.split('\n').filter(p => p.trim() !== '');
            if (prompts.length === 0) {
                promptPreviewEl.classList.add('hidden');
                return;
            }
            const prefix = promptPrefixEl.value.trim();
            const suffix = promptSuffixEl.value.trim();
            const negative = negativePromptEl.value.trim();
            const firstPrompt = prompts[0];
            const fullPrompt = [prefix, firstPrompt, suffix].filter(Boolean).join(' ');

            let previewText = fullPrompt;
            if (negative) {
                previewText += ` | Negative: ${negative}`;
            }

            promptPreviewTextEl.textContent = previewText;
            promptPreviewEl.classList.remove('hidden');
        };

        // Image Count Estimator
        const updateImageCount = () => {
            const prompts = promptsEl.value.split('\n').filter(p => p.trim() !== '');
            const selectedPresetKey = servicePresetEl.value;
            let imagesPerPrompt = 1;

            if (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4' || selectedPresetKey === 'google-imagen3-apikey') {
                imagesPerPrompt = parseInt(numberOfImagesEl.value, 10) || 1;
            }

            const totalImages = prompts.length * imagesPerPrompt;
            imageCountEl.textContent = `${totalImages} image${totalImages !== 1 ? 's' : ''}`;
        };

        // --- Helper Functions ---
        const fileToBase64 = (file, convertAlphaToWhite = false) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (convertAlphaToWhite) {
                        // Load image into canvas to convert alpha to white
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');

                            // Fill with white background
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);

                            // Draw image on top
                            ctx.drawImage(img, 0, 0);

                            // Convert to base64
                            const base64String = canvas.toDataURL('image/jpeg', 0.95).split(',')[1];
                            resolve(base64String);
                        };
                        img.onerror = reject;
                        img.src = reader.result;
                    } else {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    }
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const handleReferenceImageFile = (file) => {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                alert('Image size must be less than 10MB');
                return;
            }

            referenceImageFiles.push(file);
            updateReferenceImagePreview();
        };

        const handleReferenceImageFiles = (files) => {
            for (let file of files) {
                handleReferenceImageFile(file);
            }
        };

        const updateReferenceImagePreview = () => {
            referenceImagePreviewContainerEl.innerHTML = '';

            if (referenceImageFiles.length === 0) {
                referenceImagePlaceholderEl.classList.remove('hidden');
                referenceImagePreviewEl.classList.add('hidden');
                return;
            }

            referenceImagePlaceholderEl.classList.add('hidden');
            referenceImagePreviewEl.classList.remove('hidden');

            referenceImageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.className = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'max-h-24 rounded-md';

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '×';
                    removeBtn.className = 'absolute -top-2 -right-2 w-5 h-5 bg-red-600 text-white rounded-full text-xs hover:bg-red-700';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        referenceImageFiles.splice(index, 1);
                        updateReferenceImagePreview();
                    };

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeBtn);
                    referenceImagePreviewContainerEl.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        };

        const clearReferenceImage = () => {
            referenceImageFiles = [];
            referenceImageEl.value = '';
            updateReferenceImagePreview();
        };

        const sanitizeForFilename = (name, maxLength = 50) => {
            if (!name) return '';
            return name
                .trim()
                .toLowerCase()
                .substring(0, maxLength)
                .replace(/\s+/g, '_')
                .replace(/[^\w.-]/g, '');
        };

        const simpleHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(36).substring(0, 6);
        };

        const getNestedValue = (obj, path) => {
            try {
                const properties = path.replace(/\[(\w+)\]/g, '.$1').split('.');
                return properties.reduce((acc, key) => acc && acc[key], obj);
            } catch (error) {
                console.error("Error accessing nested value:", error);
                return undefined;
            }
        };

        const urlToBase64 = (url) => {
            // This function fetches an image from a URL and converts it to a base64 string.
            // It uses a CORS proxy to bypass browser security restrictions.
            return new Promise(async (resolve, reject) => {
                try {
                    const proxyBase = proxyUrlEl.value.trim() || 'https://corsproxy.io/?';
                    const proxyToken = proxyTokenEl.value.trim();

                    let proxyUrl = `${proxyBase}${encodeURIComponent(url)}`;
                    const fetchOptions = {};

                    // Add token if provided
                    if (proxyToken) {
                        // Check if proxy URL already has query parameters
                        const separator = proxyBase.includes('?') ? '&' : '?';
                        // Insert token before the encoded URL
                        proxyUrl = `${proxyBase}${separator}token=${encodeURIComponent(proxyToken)}&${encodeURIComponent(url)}`;
                    }

                    const response = await fetch(proxyUrl, fetchOptions);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch image via proxy: ${response.status} ${response.statusText}`);
                    }
                    const blob = await response.blob();
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        resolve(reader.result.split(',')[1]);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                } catch (error) {
                    reject(error);
                }
            });
        };
        
        const extractImageData = (item, presetKey) => {
            // This function knows how to find the image data (either base64 or a URL)
            // in the response from different APIs.
            if (presetKey.startsWith('google-')) return { base64: item.bytesBase64Encoded };
            if (presetKey === 'openai-dalle3') return { base64: item.b64_json };
            if (presetKey === 'poe-imagen4' || presetKey === 'poe-seedream4') {
                const content = item.message?.content;
                if (content) {
                    // Poe returns the URL in a markdown-like format, so we extract it.
                    const urlMatch = content.match(/(https?:\/\/[^\s)]+)/);
                    if (urlMatch && urlMatch[0]) {
                        return { url: urlMatch[0] };
                    }
                }
            }
            return {};
        };

        const updateProgress = (text, percentage) => {
            statusEl.textContent = text;
            progressBarEl.style.width = `${percentage}%`;
        };
        
        const renderImageCard = ({ filename, base64Data, error, aspectRatio = '1:1', prompt = '' }) => {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-md overflow-hidden shadow-md flex flex-col hover:shadow-lg transition-shadow group relative';

            const imageContainer = document.createElement('div');
            imageContainer.className = 'w-full bg-gray-700 flex items-center justify-center relative';
            // Dynamically set the aspect ratio for the container
            imageContainer.style.aspectRatio = aspectRatio.replace(':', ' / ');

            if (error) {
                imageContainer.innerHTML = `<p class="text-center text-red-400 text-xs p-2">${error}</p>`;
            } else {
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${base64Data}`;
                img.alt = filename;
                img.className = 'w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity';
                img.onclick = () => {
                    const win = window.open();
                    win.document.write(`<img src="${img.src}" style="max-width:100%;height:auto"/>`);
                };
                imageContainer.appendChild(img);

                // Action buttons overlay
                const actionsOverlay = document.createElement('div');
                actionsOverlay.className = 'absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2';

                const downloadBtn = document.createElement('button');
                downloadBtn.innerHTML = '⬇';
                downloadBtn.className = 'px-2 py-1 bg-green-600 hover:bg-green-700 rounded text-white text-xs';
                downloadBtn.title = 'Download';
                downloadBtn.onclick = (e) => {
                    e.stopPropagation();
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.download = filename;
                    link.click();
                };

                const copyBtn = document.createElement('button');
                copyBtn.innerHTML = '📋';
                copyBtn.className = 'px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-white text-xs';
                copyBtn.title = 'Copy prompt';
                copyBtn.onclick = (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(prompt).then(() => {
                        copyBtn.innerHTML = '✓';
                        setTimeout(() => copyBtn.innerHTML = '📋', 1000);
                    });
                };

                actionsOverlay.appendChild(downloadBtn);
                actionsOverlay.appendChild(copyBtn);
                imageContainer.appendChild(actionsOverlay);

                // Prompt tooltip
                if (prompt) {
                    const promptTooltip = document.createElement('div');
                    promptTooltip.className = 'absolute bottom-0 left-0 right-0 bg-black/80 text-white text-xs p-2 opacity-0 group-hover:opacity-100 transition-opacity';
                    promptTooltip.textContent = prompt;
                    promptTooltip.style.maxHeight = '3em';
                    promptTooltip.style.overflow = 'hidden';
                    imageContainer.appendChild(promptTooltip);
                }
            }

            const nameEl = document.createElement('p');
            nameEl.textContent = filename;
            nameEl.title = filename;
            nameEl.className = 'px-2 py-1.5 text-xs text-center text-gray-400 bg-gray-900 truncate';

            card.appendChild(imageContainer);
            card.appendChild(nameEl);
            resultsGrid.appendChild(card);
        };

        const updateAuthUI = () => {
            const selectedValue = servicePresetEl.value;

            apiKeyHelpTextEl.style.display = 'none';
            poeReferenceImageSectionEl.style.display = 'none';

            // Show/hide aspect ratio and number of images based on service
            const supportsAdvanced = selectedValue === 'google-imagen3-apikey' || selectedValue === 'poe-imagen4' || selectedValue === 'poe-seedream4';
            aspectRatioContainerEl.style.display = supportsAdvanced ? 'block' : 'none';
            numberOfImagesContainerEl.style.display = supportsAdvanced ? 'block' : 'none';

            if (supportsAdvanced) {
                apiKeyEl.placeholder = "Enter your API Key";
                if (selectedValue === 'google-imagen3-apikey') {
                    apiKeyHelpTextEl.style.display = 'block';
                }
                // Only show reference image section for Seedream-4.0
                if (selectedValue === 'poe-seedream4') {
                    poeReferenceImageSectionEl.style.display = 'block';
                }
            } else {
                apiKeyEl.placeholder = "Enter your API key";
            }

            updateImageCount();
        };

        // --- Core Logic ---
        const startGeneration = async () => {
            const prompts = promptsEl.value.split('\n').filter(p => p.trim() !== '');
            const apiKey = apiKeyEl.value.trim();
            const selectedPresetKey = servicePresetEl.value;
            const selectedPreset = SERVICE_PRESETS[selectedPresetKey];

            const prefix = promptPrefixEl.value.trim();
            const suffix = promptSuffixEl.value.trim();
            const advancedParams = {
                aspectRatio: aspectRatioEl.value,
                numberOfImages: parseInt(numberOfImagesEl.value, 10) || 1
            };

            // Handle reference images for POE models (only Seedream-4.0)
            if (selectedPresetKey === 'poe-seedream4' && referenceImageFiles.length > 0) {
                try {
                    // Convert alpha channel to white background for POE models
                    advancedParams.referenceImageBase64Array = await Promise.all(
                        referenceImageFiles.map(file => fileToBase64(file, true))
                    );
                } catch (error) {
                    alert('Failed to load reference images: ' + error.message);
                    return;
                }
            }

            if (prompts.length === 0 || !apiKey) {
                alert('Please enter your prompts and provide an API key.');
                return;
            }
            
            isGenerating = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            downloadButton.disabled = true;
            resultsGrid.innerHTML = '';
            placeholderEl.style.display = 'none';
            generatedImages = [];
            const now = new Date();
            generationTimestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

            let totalGenerations = 0;
            prompts.forEach(p => {
                totalGenerations += (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4' || selectedPresetKey === 'google-imagen3-apikey') ? advancedParams.numberOfImages : 1;
            });
            let completedGenerations = 0;

            for (let i = 0; i < prompts.length; i++) {
                if (!isGenerating) {
                    updateProgress(`Stopped by user.`, (completedGenerations / totalGenerations) * 100);
                    break;
                }
                
                const currentPrompt = prompts[i];
                const fullPrompt = [prefix, currentPrompt, suffix].filter(Boolean).join(' ');

                const sanitizedPrompt = sanitizeForFilename(currentPrompt, 25);
                const sanitizedPrefix = sanitizeForFilename(prefix, 10);
                const sanitizedSuffix = sanitizeForFilename(suffix, 10);
                const baseFilename = [String(i + 1).padStart(3, '0'), sanitizedPrompt, sanitizedPrefix, sanitizedSuffix].filter(Boolean).join('_');
                
                let numRequests = 1;
                let isMultiRequest = false;

                if ((selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4' || selectedPresetKey === 'google-imagen3-apikey')) {
                    numRequests = advancedParams.numberOfImages;
                    isMultiRequest = true;
                }

                for (let j = 0; j < numRequests; j++) {
                    if (!isGenerating) break;

                    completedGenerations++;
                    const progressPercentage = (completedGenerations / totalGenerations) * 100;
                    updateProgress(`Generating image ${j + 1} for prompt ${i + 1}...`, progressPercentage);
                    
                    let attempt = 0;
                    const maxAttempts = 2;
                    let success = false;

                    while (attempt < maxAttempts && !success && isGenerating) {
                        attempt++;
                        try {
                            let body;
                            // For Google, we pass the full image count. For Poe, we always pass 1 and loop.
                            if(selectedPresetKey === 'google-imagen3-apikey' && !isMultiRequest) {
                                 body = selectedPreset.getBody(fullPrompt, advancedParams);
                            } else {
                                 body = selectedPreset.getBody(fullPrompt, { ...advancedParams, numberOfImages: 1 });
                            }
                            
                            let finalUrl = selectedPreset.apiUrl;
                            const fetchOptions = {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                                body: body
                            };

                            if (selectedPreset.authType === 'bearer') {
                                fetchOptions.headers['Authorization'] = `Bearer ${apiKey}`;
                            } else if (selectedPreset.authType === 'apiKeyInUrl') {
                                finalUrl = `${selectedPreset.apiUrl}?key=${apiKey}`;
                            }
                            
                            const response = await fetch(finalUrl, fetchOptions);
                           
                            if (response.status === 500 && (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') && attempt < maxAttempts) {
                                throw new Error('Server error (500)'); // Trigger the retry logic
                            }

                            const data = await response.json();

                            if (!response.ok) {
                                const errorMessage = data?.error?.message || `API Error: ${response.status}`;
                                throw new Error(errorMessage);
                            }

                            success = true; // Mark as successful to exit the retry loop
                            const resultsArray = getNestedValue(data, selectedPreset.responsePath);

                            if (!resultsArray || !Array.isArray(resultsArray) || resultsArray.length === 0) {
                               if (data.error && data.error.message) throw new Error(data.error.message);
                               throw new Error('No image data found in API response.');
                            }
                            
                            let currentAspectRatio = '1:1';
                            if ((selectedPresetKey === 'google-imagen3-apikey' || selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') && advancedParams.aspectRatio !== 'default') {
                                currentAspectRatio = advancedParams.aspectRatio;
                            }

                            for (const [index, item] of resultsArray.entries()) {
                                 if (!isGenerating) break;

                                let { base64, url } = extractImageData(item, selectedPresetKey);

                                if (url) {
                                    base64 = await urlToBase64(url);
                                }
                                
                                if (base64) {
                                     const contentHash = simpleHash(base64);
                                     let filename;
                                     if (isMultiRequest) {
                                         filename = `${baseFilename}_${j + 1}_${contentHash}.png`;
                                     } else if (resultsArray.length > 1) {
                                         filename = `${baseFilename}_${index + 1}_${contentHash}.png`;
                                     } else {
                                         filename = `${baseFilename}_${contentHash}.png`;
                                     }
                                    const imageData = { filename, base64Data: base64, prompt: fullPrompt };
                                    generatedImages.push(imageData);
                                    renderImageCard({ ...imageData, aspectRatio: currentAspectRatio });
                                }
                            }
                           
                            if (isMultiRequest && j < numRequests - 1 && (selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4')) {
                                updateProgress(`Waiting before next request...`, progressPercentage);
                                await sleep(1500);
                            }

                        } catch (error) {
                            console.error(`Attempt ${attempt} failed:`, error);
                            if (error.message.includes('Server error (500)') && attempt < maxAttempts) {
                                updateProgress(`Server error. Retrying request ${j + 1} (attempt ${attempt + 1}/${maxAttempts})...`, progressPercentage);
                                await sleep(2000); // Wait before retrying
                            } else {
                                renderImageCard({ filename: `${baseFilename}.png`, error: error.message, aspectRatio: '1:1' });
                                break; // Break from the retry loop on non-retryable errors
                            }
                        }
                    }
                }
            }

            if (isGenerating) {
                 updateProgress(`Generation complete! ${generatedImages.length} images created.`, 100);
            }
            isGenerating = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            if (generatedImages.length > 0) {
                downloadButton.disabled = false;
            }
        };

        const downloadZip = async () => {
            if (generatedImages.length === 0) return;

            const zip = new JSZip();

            generatedImages.forEach(img => {
                zip.file(img.filename, img.base64Data, { base64: true });
            });

            // Add reference images if they exist
            if (referenceImageFiles.length > 0) {
                try {
                    for (let i = 0; i < referenceImageFiles.length; i++) {
                        const file = referenceImageFiles[i];
                        const referenceBase64 = await fileToBase64(file);
                        const extension = file.name.split('.').pop() || 'png';
                        const filename = referenceImageFiles.length > 1
                            ? `reference_image_${i + 1}.${extension}`
                            : `reference_image.${extension}`;
                        zip.file(filename, referenceBase64, { base64: true });
                    }
                } catch (error) {
                    console.error('Failed to add reference images to zip:', error);
                }
            }

            const selectedPresetKey = servicePresetEl.value;
            const selectedOption = servicePresetEl.options[servicePresetEl.selectedIndex].text;

            let settingsContent = `Generation Settings (${new Date().toLocaleString()})\n`;
            settingsContent += `==================================================\n\n`;
            settingsContent += `Service: ${selectedOption}\n`;
            settingsContent += `Timestamp: ${generationTimestamp}\n`;
            settingsContent += `Prompt Prefix: ${promptPrefixEl.value}\n`;
            settingsContent += `Prompt Suffix: ${promptSuffixEl.value}\n\n`;

            if (selectedPresetKey === 'google-imagen3-apikey' || selectedPresetKey === 'poe-imagen4' || selectedPresetKey === 'poe-seedream4') {
                settingsContent += `--- Advanced Settings ---\n`;
                settingsContent += `Aspect Ratio: ${aspectRatioEl.value}\n`;
                settingsContent += `Number of Images Per Prompt: ${numberOfImagesEl.value}\n`;
                if (referenceImageFiles.length > 0) {
                    settingsContent += `Reference Images: ${referenceImageFiles.length}\n`;
                    referenceImageFiles.forEach((file, i) => {
                        const extension = file.name.split('.').pop() || 'png';
                        const filename = referenceImageFiles.length > 1
                            ? `reference_image_${i + 1}.${extension}`
                            : `reference_image.${extension}`;
                        settingsContent += `  - ${filename}\n`;
                    });
                }
                settingsContent += `\n`;
            }

            settingsContent += `--- Full Prompts List ---\n`;
            settingsContent += promptsEl.value;

            zip.file('generation_settings.txt', settingsContent);

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `generated_images_${generationTimestamp}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        };

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            saveApiKey();
            startGeneration();
        });
        stopButton.addEventListener('click', () => { isGenerating = false; });
        downloadButton.addEventListener('click', downloadZip);
        servicePresetEl.addEventListener('change', updateAuthUI);

        // API Key management
        clearApiKeyEl.addEventListener('click', () => {
            apiKeyEl.value = '';
            saveApiKeyEl.checked = false;
            localStorage.removeItem('apiKey');
        });

        // Prompt preview and image count updates
        promptsEl.addEventListener('input', () => {
            updatePromptPreview();
            updateImageCount();
        });
        promptPrefixEl.addEventListener('input', updatePromptPreview);
        promptSuffixEl.addEventListener('input', updatePromptPreview);
        negativePromptEl.addEventListener('input', updatePromptPreview);
        numberOfImagesEl.addEventListener('input', updateImageCount);

        // Reference image handlers
        referenceImageDropZoneEl.addEventListener('click', () => referenceImageEl.click());
        referenceImageEl.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleReferenceImageFiles(e.target.files);
            }
        });
        removeReferenceImageEl.addEventListener('click', (e) => {
            e.stopPropagation();
            clearReferenceImage();
        });

        // Drag and drop handlers
        referenceImageDropZoneEl.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            referenceImageDropZoneEl.classList.add('border-indigo-500', 'bg-gray-600');
        });
        referenceImageDropZoneEl.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            referenceImageDropZoneEl.classList.remove('border-indigo-500', 'bg-gray-600');
        });
        referenceImageDropZoneEl.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            referenceImageDropZoneEl.classList.remove('border-indigo-500', 'bg-gray-600');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleReferenceImageFiles(files);
            }
        });

        // Paste handler for reference image (global listener)
        document.addEventListener('paste', (e) => {
            // Only handle paste when POE reference section is visible
            if (poeReferenceImageSectionEl.style.display !== 'none') {
                const items = e.clipboardData?.items;
                if (items) {
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = items[i].getAsFile();
                            if (file) {
                                handleReferenceImageFile(file);
                            }
                            break;
                        }
                    }
                }
            }
        });

        // --- URL Parameter Pre-population ---
        const loadUrlParameters = () => {
            const urlParams = new URLSearchParams(window.location.search);

            // Pre-populate API key if provided
            const apiKeyParam = urlParams.get('apiKey') || urlParams.get('apikey') || urlParams.get('key');
            if (apiKeyParam) {
                apiKeyEl.value = apiKeyParam;
            }

            // Pre-populate proxy URL if provided
            const proxyParam = urlParams.get('proxy') || urlParams.get('proxyUrl');
            if (proxyParam) {
                proxyUrlEl.value = proxyParam;
            }

            // Pre-populate proxy token if provided
            const proxyTokenParam = urlParams.get('proxyToken') || urlParams.get('proxytoken') || urlParams.get('token');
            if (proxyTokenParam) {
                proxyTokenEl.value = proxyTokenParam;
            }
        };

        // --- Initial UI Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKey();
            loadUrlParameters();
            updateAuthUI();
            updatePromptPreview();
            updateImageCount();
        });
    </script>
</body>
</html>

