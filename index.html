<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Simple scrollbar styling for a consistent look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .placeholder-gray-500::placeholder { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Batch Image Generator</h1>
            <p class="text-gray-400">Generate multiple images from a list of prompts using preset services.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ========== Configuration Column ========== -->
            <div class="flex flex-col space-y-6">
                <!-- Prompts Section -->
                <div>
                    <label for="prompts" class="block text-sm font-medium text-gray-300 mb-2">1. Enter Prompts (one per line)</label>
                    <textarea id="prompts" rows="8" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-200 placeholder-gray-500" placeholder="A futuristic city at sunset&#10;A robot reading a book in a library&#10;A fantasy landscape with floating islands...">A smiling sloth in a business suit
A majestic jellyfish floating in a starry galaxy
A cozy library in a treehouse during a gentle rain</textarea>
                </div>

                <!-- API Configuration Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3">2. Service Configuration</h2>
                    <div class="space-y-4 bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="promptPrefix" class="block text-sm font-medium text-gray-300">Prompt Prefix</label>
                                <input type="text" id="promptPrefix" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="e.g., photo of">
                            </div>
                            <div>
                                <label for="promptSuffix" class="block text-sm font-medium text-gray-300">Prompt Suffix</label>
                                <input type="text" id="promptSuffix" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="e.g., 4k, detailed">
                            </div>
                        </div>
                        <div>
                            <label for="servicePreset" class="block text-sm font-medium text-gray-300">Image Generation Service</label>
                            <select id="servicePreset" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="google-imagen3-apikey">Google - Imagen 3 (API Key)</option>
                                <option value="google-imagen4-token">Google - Imagen 4 (Access Token)</option>
                                <option value="openai-dalle3">OpenAI - DALL-E 3</option>
                            </select>
                        </div>

                        <!-- Imagen 3 Specific Settings -->
                        <div id="imagen3Settings" class="space-y-4 p-3 bg-gray-900/50 rounded-md border border-gray-600" style="display: none;">
                            <h4 class="text-sm font-semibold text-gray-300">Imagen 3 Settings</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="aspectRatio" class="block text-xs font-medium text-gray-400">Aspect Ratio</label>
                                    <select id="aspectRatio" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-sm">
                                        <option value="1:1">1:1 (Square)</option>
                                        <option value="16:9">16:9 (Widescreen)</option>
                                        <option value="9:16">9:16 (Vertical)</option>
                                        <option value="4:3">4:3 (Standard)</option>
                                        <option value="3:4">3:4 (Portrait)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="numberOfImages" class="block text-xs font-medium text-gray-400">Number of Images</label>
                                    <input type="number" id="numberOfImages" value="1" min="1" max="4" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm text-sm">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-300">API Key / Access Token</label>
                            <input type="password" id="apiKey" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="Enter your API key or access token">
                            <p id="apiKeyHelpText" class="mt-2 text-xs text-gray-400" style="display: none;">
                                To use this, you need a Google Cloud API Key. 
                                <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-indigo-400 hover:underline">Create one here</a>.
                            </p>
                            <p id="authHelpText" class="mt-2 text-xs text-gray-400" style="display: none;">
                                Generate a temporary token with the gcloud CLI: 
                                <code class="bg-gray-700 p-1 rounded">gcloud auth print-access-token</code>. 
                                <a href="https://cloud.google.com/sdk/gcloud/reference/auth/print-access-token" target="_blank" class="text-indigo-400 hover:underline">Learn more</a>.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div>
                     <h2 class="text-lg font-semibold text-white mb-3">3. Generate & Download</h2>
                    <div class="flex items-center space-x-4">
                        <button id="startButton" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 transition duration-150">Start Generation</button>
                        <button id="stopButton" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-150" disabled>Stop</button>
                    </div>
                </div>
                
                <!-- Progress -->
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div id="status" class="text-gray-400 text-sm">Status: Idle</div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ========== Output Column ========== -->
            <div class="flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Results</h2>
                    <button id="downloadButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-150" disabled>Download All as .zip</button>
                </div>
                <div id="resultsGrid" class="flex-grow bg-gray-800/50 border border-gray-700 rounded-lg p-4 h-96 lg:h-auto overflow-y-auto">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-4">
                        <!-- Generated images will appear here -->
                    </div>
                     <div id="placeholder" class="flex items-center justify-center h-full">
                        <p class="text-gray-500">Your generated images will appear here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Presets ---
        const SERVICE_PRESETS = {
            'google-imagen3-apikey': {
                name: 'Google - Imagen 3 (API Key)',
                authType: 'apiKeyInUrl',
                apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict',
                getBody: (prompt, params) => {
                    return JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: {
                            sampleCount: params.numberOfImages,
                            aspectRatio: params.aspectRatio
                        }
                    });
                },
                responsePath: 'predictions'
            },
            'google-imagen4-token': {
                name: 'Google - Imagen 4 (Access Token)',
                authType: 'bearer',
                apiUrl: 'https://us-central1-aiplatform.googleapis.com/v1/projects/gen-lang-client-0907036644/locations/us-central1/publishers/google/models/imagen@4:predict',
                getBody: (prompt) => {
                    return JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: { sampleCount: 1 }
                    });
                },
                responsePath: 'predictions'
            },
            'openai-dalle3': {
                name: 'OpenAI - DALL-E 3',
                authType: 'bearer',
                apiUrl: 'https://api.openai.com/v1/images/generations',
                getBody: (prompt) => {
                     return JSON.stringify({
                        model: "dall-e-3",
                        prompt: prompt,
                        n: 1,
                        size: "1024x1024",
                        response_format: "b64_json"
                    });
                },
                responsePath: 'data'
            }
        };

        // DOM Elements
        const promptsEl = document.getElementById('prompts');
        const servicePresetEl = document.getElementById('servicePreset');
        const apiKeyEl = document.getElementById('apiKey');
        const authHelpTextEl = document.getElementById('authHelpText');
        const apiKeyHelpTextEl = document.getElementById('apiKeyHelpText');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusEl = document.getElementById('status');
        const progressBarEl = document.getElementById('progressBar');
        const resultsGrid = document.getElementById('resultsGrid').querySelector('.grid');
        const placeholderEl = document.getElementById('placeholder');
        const promptPrefixEl = document.getElementById('promptPrefix');
        const promptSuffixEl = document.getElementById('promptSuffix');
        const imagen3SettingsEl = document.getElementById('imagen3Settings');
        const aspectRatioEl = document.getElementById('aspectRatio');
        const numberOfImagesEl = document.getElementById('numberOfImages');

        // State
        let isGenerating = false;
        let generatedImages = [];
        let generationTimestamp = '';

        // --- Helper Functions ---
        const sanitizeFilename = (name) => {
            if (!name) return 'untitled';
            return name
                .trim()
                .toLowerCase()
                .substring(0, 50)
                .replace(/\s+/g, '_')
                .replace(/[^\w.-]/g, '');
        };

        const getNestedValue = (obj, path) => {
            try {
                const properties = path.replace(/\[(\w+)\]/g, '.$1').split('.');
                return properties.reduce((acc, key) => acc && acc[key], obj);
            } catch (error) {
                console.error("Error accessing nested value:", error);
                return undefined;
            }
        };
        
        const getBase64FromItem = (item, presetKey) => {
            if (presetKey.startsWith('google-')) return item.bytesBase64Encoded;
            if (presetKey === 'openai-dalle3') return item.b64_json;
            return null;
        };

        const updateProgress = (text, percentage) => {
            statusEl.textContent = `Status: ${text}`;
            progressBarEl.style.width = `${percentage}%`;
        };
        
        const renderImageCard = ({ filename, base64Data, error, aspectRatio = '1:1' }) => {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'w-full bg-gray-700 flex items-center justify-center';
            // Dynamically set the aspect ratio of the container
            imageContainer.style.aspectRatio = aspectRatio.replace(':', ' / ');

            if (error) {
                imageContainer.innerHTML = `<p class="text-center text-red-400 text-xs p-2">${error}</p>`;
            } else {
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${base64Data}`;
                img.alt = filename;
                img.className = 'w-full h-full object-cover';
                imageContainer.appendChild(img);
            }
            
            const nameEl = document.createElement('p');
            nameEl.textContent = filename;
            nameEl.className = 'p-2 text-xs text-center text-gray-400 bg-gray-900 truncate';

            card.appendChild(imageContainer);
            card.appendChild(nameEl);
            resultsGrid.appendChild(card);
        };

        const updateAuthUI = () => {
            const selectedValue = servicePresetEl.value;
            
            apiKeyHelpTextEl.style.display = 'none';
            authHelpTextEl.style.display = 'none';
            imagen3SettingsEl.style.display = 'none';

            if (selectedValue === 'google-imagen4-token') {
                apiKeyEl.placeholder = "Enter your temporary OAuth 2.0 Access Token";
                authHelpTextEl.style.display = 'block';
            } else if (selectedValue === 'google-imagen3-apikey') {
                apiKeyEl.placeholder = "Enter your Google Cloud API Key";
                apiKeyHelpTextEl.style.display = 'block';
                imagen3SettingsEl.style.display = 'block';
            } else {
                apiKeyEl.placeholder = "Enter your API key";
            }
        };

        // --- Core Logic ---
        const startGeneration = async () => {
            const prompts = promptsEl.value.split('\n').filter(p => p.trim() !== '');
            const apiKey = apiKeyEl.value.trim();
            const selectedPresetKey = servicePresetEl.value;
            const selectedPreset = SERVICE_PRESETS[selectedPresetKey];
            
            const prefix = promptPrefixEl.value.trim();
            const suffix = promptSuffixEl.value.trim();
            const imagen3Params = {
                aspectRatio: aspectRatioEl.value,
                numberOfImages: parseInt(numberOfImagesEl.value, 10) || 1
            };

            if (prompts.length === 0 || !apiKey) {
                alert('Please enter your prompts and provide an API key/access token.');
                return;
            }
            
            isGenerating = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            downloadButton.disabled = true;
            resultsGrid.innerHTML = '';
            placeholderEl.style.display = 'none';
            generatedImages = [];
            const now = new Date();
            generationTimestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

            for (let i = 0; i < prompts.length; i++) {
                if (!isGenerating) {
                    updateProgress(`Stopped by user.`, (i / prompts.length) * 100);
                    break;
                }
                
                const currentPrompt = prompts[i];
                const fullPrompt = [prefix, currentPrompt, suffix].filter(Boolean).join(' ');
                const progressPercentage = ((i + 1) / prompts.length) * 100;
                updateProgress(`Generating ${i + 1} of ${prompts.length}: "${currentPrompt.substring(0, 30)}..."`, progressPercentage);
                const baseFilename = `${String(i + 1).padStart(3, '0')}-${sanitizeFilename(fullPrompt)}`;
                
                try {
                    let body;
                    if (selectedPresetKey === 'google-imagen3-apikey') {
                        body = selectedPreset.getBody(fullPrompt, imagen3Params);
                    } else {
                        body = selectedPreset.getBody(fullPrompt);
                    }
                    
                    let finalUrl = selectedPreset.apiUrl;
                    const fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: body
                    };

                    if (selectedPreset.authType === 'bearer') {
                        fetchOptions.headers['Authorization'] = `Bearer ${apiKey}`;
                    } else if (selectedPreset.authType === 'apiKeyInUrl') {
                        finalUrl = `${selectedPreset.apiUrl}?key=${apiKey}`;
                    }
                    
                    const response = await fetch(finalUrl, fetchOptions);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        let errorMessage = errorData?.error?.message || `API Error: ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    const resultsArray = getNestedValue(data, selectedPreset.responsePath);

                    if (!resultsArray || !Array.isArray(resultsArray) || resultsArray.length === 0) {
                       if (data.error && data.error.message) {
                           throw new Error(data.error.message);
                       }
                       throw new Error('No image data found in API response.');
                    }
                    
                    let currentAspectRatio = '1:1';
                    if (selectedPresetKey === 'google-imagen3-apikey') {
                        currentAspectRatio = imagen3Params.aspectRatio;
                    }

                    resultsArray.forEach((item, index) => {
                        const base64Data = getBase64FromItem(item, selectedPresetKey);
                        if (base64Data) {
                             const filename = resultsArray.length > 1 
                                ? `${baseFilename}_${index + 1}.png`
                                : `${baseFilename}.png`;
                            const imageData = { filename, base64Data };
                            generatedImages.push(imageData);
                            renderImageCard({ ...imageData, aspectRatio: currentAspectRatio });
                        }
                    });

                } catch (error) {
                    console.error('Generation error:', error);
                    renderImageCard({ filename: `${baseFilename}.png`, error: error.message });
                }
            }

            if (isGenerating) {
                 updateProgress(`Generation complete! ${generatedImages.length} images created.`, 100);
            }
            isGenerating = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            if (generatedImages.length > 0) {
                downloadButton.disabled = false;
            }
        };

        const downloadZip = () => {
            if (generatedImages.length === 0) return;

            const zip = new JSZip();
            generatedImages.forEach(img => {
                zip.file(img.filename, img.base64Data, { base64: true });
            });

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `generated_images_${generationTimestamp}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        };

        // --- Event Listeners ---
        startButton.addEventListener('click', startGeneration);
        stopButton.addEventListener('click', () => { isGenerating = false; });
        downloadButton.addEventListener('click', downloadZip);
        servicePresetEl.addEventListener('change', updateAuthUI);

        // --- Initial UI Setup ---
        document.addEventListener('DOMContentLoaded', updateAuthUI);
    </script>
</body>
</html>


