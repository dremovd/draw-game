<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Simple scrollbar styling for a consistent look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .placeholder-gray-500::placeholder { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <div class="container mx-auto p-4 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Batch Image Generator</h1>
            <p class="text-gray-400">Generate multiple images from a list of prompts using preset services.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ========== Configuration Column ========== -->
            <div class="flex flex-col space-y-6">
                <!-- Prompts Section -->
                <div>
                    <label for="prompts" class="block text-sm font-medium text-gray-300 mb-2">1. Enter Prompts (one per line)</label>
                    <textarea id="prompts" rows="10" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-gray-200 placeholder-gray-500" placeholder="A futuristic city at sunset&#10;A robot reading a book in a library&#10;A fantasy landscape with floating islands...">A smiling sloth in a business suit
A majestic jellyfish floating in a starry galaxy
A cozy library in a treehouse during a gentle rain</textarea>
                </div>

                <!-- API Configuration Section -->
                <div>
                    <h2 class="text-lg font-semibold text-white mb-3">2. Service Configuration</h2>
                    <div class="space-y-4 bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                        <div>
                            <label for="servicePreset" class="block text-sm font-medium text-gray-300">Image Generation Service</label>
                            <select id="servicePreset" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="openai-dalle3">OpenAI - DALL-E 3</option>
                                <option value="google-imagen3">Google - Imagen 3</option>
                                <option value="stability-sd-v1.6">Stability AI - SD v1.6</option>
                            </select>
                        </div>
                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-300">API Key</label>
                            <input type="password" id="apiKey" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded-md shadow-sm" placeholder="Enter your API key for the selected service">
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div>
                     <h2 class="text-lg font-semibold text-white mb-3">3. Generate & Download</h2>
                    <div class="flex items-center space-x-4">
                        <button id="startButton" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 focus:ring-offset-gray-900 transition duration-150">Start Generation</button>
                        <button id="stopButton" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-md shadow-md hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-150" disabled>Stop</button>
                    </div>
                </div>
                
                <!-- Progress -->
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                    <div id="status" class="text-gray-400 text-sm">Status: Idle</div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- ========== Output Column ========== -->
            <div class="flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-white">Results</h2>
                    <button id="downloadButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-md hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition duration-150" disabled>Download All as .zip</button>
                </div>
                <div id="resultsGrid" class="flex-grow bg-gray-800/50 border border-gray-700 rounded-lg p-4 h-96 lg:h-auto overflow-y-auto">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-4">
                        <!-- Generated images will appear here -->
                    </div>
                     <div id="placeholder" class="flex items-center justify-center h-full">
                        <p class="text-gray-500">Your generated images will appear here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Presets ---
        const SERVICE_PRESETS = {
            'openai-dalle3': {
                name: 'OpenAI - DALL-E 3',
                authType: 'bearer',
                apiUrl: 'https://api.openai.com/v1/images/generations',
                bodyTemplate: `{"model": "dall-e-3", "prompt": "{prompt}", "n": 1, "size": "1024x1024", "response_format": "b64_json"}`,
                responsePath: 'data[0].b64_json'
            },
            'google-imagen3': {
                name: 'Google - Imagen 3',
                authType: 'apiKeyInUrl',
                apiUrl: 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict',
                bodyTemplate: `{"instances": [{"prompt": "{prompt}"}], "parameters": {"sampleCount": 1}}`,
                responsePath: 'predictions[0].bytesBase64Encoded'
            },
            'stability-sd-v1.6': {
                name: 'Stability AI - SD v1.6',
                authType: 'bearer',
                apiUrl: 'https://api.stability.ai/v1/generation/stable-diffusion-v1-6/text-to-image',
                bodyTemplate: `{"text_prompts": [{"text": "{prompt}"}], "samples": 1, "steps": 30}`,
                responsePath: 'artifacts[0].base64'
            }
        };

        // DOM Elements
        const promptsEl = document.getElementById('prompts');
        const servicePresetEl = document.getElementById('servicePreset');
        const apiKeyEl = document.getElementById('apiKey');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const downloadButton = document.getElementById('downloadButton');
        const statusEl = document.getElementById('status');
        const progressBarEl = document.getElementById('progressBar');
        const resultsGrid = document.getElementById('resultsGrid').querySelector('.grid');
        const placeholderEl = document.getElementById('placeholder');

        // State
        let isGenerating = false;
        let generatedImages = [];
        let generationTimestamp = '';

        // --- Helper Functions ---

        /**
         * Sanitizes a string to be a valid filename.
         * @param {string} name - The input string from a prompt.
         * @returns {string} A filesystem-safe string.
         */
        const sanitizeFilename = (name) => {
            if (!name) return 'untitled';
            return name
                .toLowerCase()
                .substring(0, 30) // Truncate
                .replace(/\s+/g, '_') // Replace spaces with underscores
                .replace(/[^\w.-]/g, ''); // Remove non-word characters except dots and hyphens
        };

        /**
         * Accesses a nested property in an object using a string path.
         * @param {object} obj - The object to search.
         * @param {string} path - The path string (e.g., 'data[0].b64_json').
         * @returns {any} The value at the path, or undefined if not found.
         */
        const getNestedValue = (obj, path) => {
            try {
                // Handle array accessors like [0]
                const properties = path.replace(/\[(\w+)\]/g, '.$1').split('.');
                return properties.reduce((acc, key) => acc && acc[key], obj);
            } catch (error) {
                console.error("Error accessing nested value:", error);
                return undefined;
            }
        };

        /**
         * Updates the UI to reflect the current progress.
         * @param {string} text - The status text to display.
         * @param {number} percentage - The progress bar percentage (0-100).
         */
        const updateProgress = (text, percentage) => {
            statusEl.textContent = `Status: ${text}`;
            progressBarEl.style.width = `${percentage}%`;
        };
        
        /**
         * Renders an image card in the results grid.
         * @param {object} imageData - Contains filename and base64 data or an error message.
         */
        const renderImageCard = ({ filename, base64Data, error }) => {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'w-full h-40 bg-gray-700 flex items-center justify-center';

            if (error) {
                imageContainer.innerHTML = `<p class="text-center text-red-400 text-xs p-2">${error}</p>`;
            } else {
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${base64Data}`;
                img.alt = filename;
                img.className = 'w-full h-full object-cover';
                imageContainer.appendChild(img);
            }
            
            const nameEl = document.createElement('p');
            nameEl.textContent = filename;
            nameEl.className = 'p-2 text-xs text-center text-gray-400 bg-gray-900 truncate';

            card.appendChild(imageContainer);
            card.appendChild(nameEl);
            resultsGrid.appendChild(card);
        };

        // --- Core Logic ---

        const startGeneration = async () => {
            const prompts = promptsEl.value.split('\n').filter(p => p.trim() !== '');
            const apiKey = apiKeyEl.value.trim();
            const selectedPreset = SERVICE_PRESETS[servicePresetEl.value];
            
            if (prompts.length === 0 || !apiKey) {
                alert('Please enter your prompts and provide an API key.');
                return;
            }
            
            // UI setup for generation
            isGenerating = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            downloadButton.disabled = true;
            resultsGrid.innerHTML = '';
            placeholderEl.style.display = 'none';
            generatedImages = [];
            const now = new Date();
            generationTimestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}-${String(now.getSeconds()).padStart(2, '0')}`;


            for (let i = 0; i < prompts.length; i++) {
                if (!isGenerating) {
                    updateProgress(`Stopped by user.`, (i / prompts.length) * 100);
                    break;
                }
                
                const currentPrompt = prompts[i];
                const progressPercentage = ((i + 1) / prompts.length) * 100;
                updateProgress(`Generating ${i + 1} of ${prompts.length}: "${currentPrompt.substring(0, 40)}..."`, progressPercentage);

                const filename = `${String(i + 1).padStart(3, '0')}-${sanitizeFilename(currentPrompt)}.png`;
                
                try {
                    // Escape the prompt text for safe injection into the JSON string template
                    const escapedPrompt = JSON.stringify(currentPrompt).slice(1, -1);
                    const body = selectedPreset.bodyTemplate.replace('{prompt}', escapedPrompt);

                    let finalUrl = selectedPreset.apiUrl;
                    const fetchOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: body
                    };

                    // Handle different authentication methods
                    if (selectedPreset.authType === 'bearer') {
                        fetchOptions.headers['Authorization'] = `Bearer ${apiKey}`;
                    } else if (selectedPreset.authType === 'apiKeyInUrl') {
                        finalUrl = `${selectedPreset.apiUrl}?key=${apiKey}`;
                    }

                    const response = await fetch(finalUrl, fetchOptions);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                        const errorMessage = errorData?.error?.message || `API Error: ${response.status}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    const base64Data = getNestedValue(data, selectedPreset.responsePath);

                    if (!base64Data) {
                       throw new Error('Image data not found at specified response path.');
                    }
                    
                    const imageData = { filename, base64Data };
                    generatedImages.push(imageData);
                    renderImageCard(imageData);

                } catch (error) {
                    console.error('Generation error:', error);
                    let errorMessage = error.message;
                    if (error instanceof TypeError && error.message.includes("non ISO-8859-1")) {
                        errorMessage = "Invalid character in API Key. Please check for smart quotes or other special characters and re-paste it.";
                    }
                    renderImageCard({ filename, error: errorMessage });
                }
            }

            // Final UI state
            if (isGenerating) {
                 updateProgress(`Generation complete! ${generatedImages.length} images created.`, 100);
            }
            isGenerating = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            if (generatedImages.length > 0) {
                downloadButton.disabled = false;
            }
        };

        const downloadZip = () => {
            if (generatedImages.length === 0) return;

            const zip = new JSZip();
            generatedImages.forEach(img => {
                zip.file(img.filename, img.base64Data, { base64: true });
            });

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `generated_images_${generationTimestamp}.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
        };

        // --- Event Listeners ---
        startButton.addEventListener('click', startGeneration);
        stopButton.addEventListener('click', () => { isGenerating = false; });
        downloadButton.addEventListener('click', downloadZip);

    </script>
</body>
</html>




